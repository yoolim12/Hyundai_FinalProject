<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="fragments/common :: header('게시판')">
<meta charset="UTF-8">
	<title>게시물</title>
  <!-- 
  /* 작성자 : 문혁
 * 게시글 추가 페이지. 
 */
   -->	
</head>
<body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top" th:replace="fragments/common :: menu('board')"></nav>

	<h2 class="text-center">글쓰기</h2> <br>
	<form role="form"  method="post">
		<table class="table table-striped">
			<tr>
				<th>제목</th>
				<td><input type="text" name="title" autofocus="autofocus"
					required="required" /></td>
			</tr>
			<tr>
				<th>ID</th>
				<td><input type="text" name="email" th:value = '${user.email}' required="required" readonly /></td>
			</tr>
			<tr>
				<th>비밀번호</th>
				<td><input type="password" name="password" required="required" /></td>
			</tr>
			<tr>
				<th>첨부파일</th>
				<td class="form-group uploadDiv"><input type="file" name='uploadFile' multiple></td>
				 
			</tr>
			<tr>
				<td colspan="2" class='uploadResult'> <ul></ul></td>			
			</tr>
			<tr>
				<th>내용</th>
				<td><textarea name="content" rows="5" cols="40"
						required="required"></textarea></td>
			</tr>
			<tr>
				<td colspan="2" align="center"><button type="submit" class="btn btn-success">업로드</button></td>
			</tr>

		</table>
	</form>
	
	<!-- 서브밋버튼 눌렀을때 첨부파일 관련 처리 할수있도록 기본동작 막기  -->
	<script
	       src="https://code.jquery.com/jquery-3.5.1.min.js"
	       integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
	       crossorigin="anonymous">
	</script>
	<script>
	$(document).ready(function(e){
		  var formObj = $("form[role='form']");
		  
		  $("button[type='submit']").on("click", function(e){    
		    e.preventDefault();   //기본동작 막기 
		    console.log("submit clicked");   
			
			
		    var str = "";    //data-uuid, data-filename, data-type 추출
		    $(".uploadResult ul li").each(function(i, obj){      
		      var jobj = $(obj);      
		      console.dir(jobj);
		      console.log("-------------------------");
		      console.log(jobj.data("filename"));      
		      str += "<input type='hidden' name='attachList["+i+"].fileName' value='"+jobj.data("filename")+"'>";
		      str += "<input type='hidden' name='attachList["+i+"].uuid' value='"+jobj.data("uuid")+"'>";
		      str += "<input type='hidden' name='attachList["+i+"].folderPath' value='"+jobj.data("path")+"'>";
		      str += "<input type='hidden' name='attachList["+i+"].fileType' value='"+ jobj.data("type")+"'>"; 
		});
		  console.log(str);    
		  formObj.append(str).submit(); //from 태그에 내용 추가해서 전송    
		});//end sumit 버튼 클릭
		    //파일 확장자 패턴 저장
		    var regex = new RegExp("(.*?)\.(exe|sh|zip|alz)$");
		    var maxSize = 5242880; //5MB
	
		    //파일 체크 함수
		    function checkExtension(fileName, fileSize){    
		      if(fileSize >= maxSize){
		        alert("파일 사이즈 초과");
		        return false;
		      }//end if    
		      if(regex.test(fileName)){
		        alert("해당 종류의 파일은 업로드할 수 없습니다.");
		        return false;
		      }
		      return true;
		    }//end chekc....
	
		    $("input[type='file']").change(function(e){
		        var formData = new FormData();
		        var inputFile = $("input[name='uploadFile']");
		        var files = inputFile[0].files;
	
		        for(var i = 0; i < files.length; i++){
		          if(!checkExtension(files[i].name, files[i].size) ){
		            return false;
		          }//end if
		          formData.append("uploadFile", files[i]);  
		        }//end for
		        console.log(files);
	
		        $.ajax({
		          url: '/uploadAjax',
		          processData: false, 
		          contentType: false,
		          data: formData,
		          type: 'POST',
		          dataType:'json',
		          success: function(result){
		            console.log(result);
		            showUploadResult(result); //업로드 결과 처리 함수 
		          }//end datatype
		        }); //$.ajax
		      }); //end inputcha..
	
		      function showUploadResult(uploadResultArr){
		    	    //업로드 파일 갯수 0개
		          if(!uploadResultArr || uploadResultArr.length == 0){ 
		            return; //함수 종료 
		          }//end if
		          
		          var uploadUL = $(".uploadResult ul");      
		          var str ="";
		          
		          $(uploadResultArr).each(function(i, obj){        
		            //image type
		            if(true){
		              // 컨트롤러에 전달할 원본 이미지 패스
		              var fileCallPath =  encodeURIComponent( obj.folderPath+ "/"+obj.uuid +"_"+obj.fileName);
		              // 글쓰기 페이지에서 보여줄 썸네일 이미지 패스
		              var tfileCallPath =  encodeURIComponent( obj.folderPath+ "/s_"+obj.uuid +"_"+obj.fileName);
		        			str += "<li data-path='"+obj.folderPath+"'";
		        			str +=" data-uuid='"+obj.uuid+"' data-filename='"+obj.fileName+"' data-type='"+obj.image+"'"
		    	    		str +" ><div>";
		    	    		str += "<span> "+ obj.fileName+"</span>";
		        			str += "<button type='button' data-file=\'"+fileCallPath+"\' "
		        			str += "data-type='image' class='btn btn-warning btn-circle'><i class='close '>x</i></button><br>";
		    	    		str += "<img src='/board/display?fileName="+tfileCallPath+"'>";
		    	    		str += "</div>";
		    	    		str +"</li>";
		              }
		          });//end uploadResultArr).each   
		            uploadUL.append(str);
		          } //end showUploadResult  
		          
		      // X버튼 클릭
		      $(".uploadResult").on("click", "button", function(e){	    
		        console.log("delete file");
		          
		        var targetFile = $(this).data("file");
		        var type = $(this).data("type");      
		        var targetLi = $(this).closest("li");
		        
		        $.ajax({ //삭제처리 호출
		          url: '/removeFile',
		          data: {fileName: targetFile, type:type},
		          dataType:'text',
		          type: 'POST',
		            success: function(result){
		               alert("삭제되었습니다");             
		               targetLi.remove();
		             }
		        }); //$.ajax
		       });//end  uploadResult").on("click"  
	
		  });//end ready
	</script>



</body>
</html>